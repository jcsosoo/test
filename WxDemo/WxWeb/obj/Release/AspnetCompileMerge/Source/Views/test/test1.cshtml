
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>test</title>
    <script src="~/Scripts/jquery-1.10.2.js"></script>
</head>
<body>
    <div>
        <button id="code">点击</button> 
        <p id="msg"></p>
    </div>
    <script>
        var code = GetQueryString('code');
        var sendMsg;

        $(function(){

            $.ajax({
                async: false,
                url: "/test/getOpenId",
                data: { code:code},
                success: function (data) {
                    var json = jQuery.parseJSON(data);
                    $("#msg").html(json.openid);
                    sessionStorage.setItem("userid", json.openid);
                    sendMsg = {
                    "touser": json.openid,
                    "msgtype": "text",
                    "text":
                    {
                        "content": "你好，用户：" + json.openid
                    }
                    }
            }
                
            });
            //判断用户是否存在
            $("a").click(function () {
                $.ajax({
                    async: false,
                    url: "/User/selectUser",
                    data: { UserId: sessionStorage.getItem("userid") },
                    success: function (data) {
                        if (data.toString() == "False") {
                            window.location.href = "http://www.elugo.cn/User/Index";
                        }
                    }

                });

            });


            
        });

        $("#code").click(function(){
            $.ajax({
                url: "/MsgMgr/sendMsg",
                data: { text: JSON.stringify(sendMsg)},
                success: function (data) {

                }

            });


        });

        //js获取地址栏参数
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }
    </script>
</body>
</html>
