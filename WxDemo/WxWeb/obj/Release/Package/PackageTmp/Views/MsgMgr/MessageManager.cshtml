
@{
    ViewBag.Title = "消息管理";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>MessageManager</h2>

<div class="row">
    <div class="col-md-4">
        <h3>获取用户</h3>
        <p><a class="btn btn-default" href="#" id="getYh">获取 &raquo;</a></p>
        <h3>发送图文信息</h3>
        <p><a class="btn btn-default" href="#" id="sendMsg">发送 &raquo;</a></p>
        <h3>图片上传</h3>
        <form id="upload" method="post" action="" enctype="multipart/form-data" return-type="json" target="result-iframe">
            <input type="file" id="media" name="media" style="margin-bottom:10px;" />            
        </form>
        <p><a class="btn btn-default" href="#" id="getId">上传 &raquo;</a></p>
        <h3>群发</h3>
        <p><a class="btn btn-default" href="#" id="sendAllMsg">发送 &raquo;</a></p>
    </div>
    <div class="col-md-8">
        <div class="row">
            <div class="col-md-12">
                <h3 style="display:block;width:600px">内容</h3>
                <textarea name="" id="Text" cols="30" rows="10" style="width:600px;max-width:600px"></textarea>
            </div>
            <div class="col-md-12">
                <h3 style="display:block;width:600px">返回消息</h3>
                <textarea name="" id="Msg" cols="30" rows="10" style="width:600px;max-width:600px"></textarea>
                @*隐藏form跳转*@
                <iframe id="result-iframe" name="result-iframe" cols="30" rows="10" style="width:600px;max-width:600px;display:none;border:1px solid rgb(169, 169, 169)"></iframe>
            </div>
        </div>
    </div>

   
</div>


<script>

    $("#getYh").click(function () {
       
        $.ajax({
            url: "/MsgMgr/getYh",
            data: { },
            success: function (data) {
                showHide();
                $("#Msg").val(data);
            },
            error: function (data) {
                showHide();
                $("#Msg").val(data);
            }
        });
    });
    $("#sendMsg").click(function () {
        var m = $("#Text").val();
        if (m == null || m == "") {
            alert("请输入发送的内容");
            return;
        }
        $.ajax({
            url: "/MsgMgr/sendMsg",
            data: { text: m },
            success: function (data) {
                showHide();
                $("#Msg").val(data);
            },
            error: function (data) {
                showHide();
                $("#Msg").val(data);
            }
        });
    });

    $("#getId").click(function () {
        var a = $("#media").val();
        //var m = $('#upload').serialize();
        if (a == null || a == "") {
            alert("请选择上传的文件");
            return;
        }
        $.ajax({
            
            url: "/Home/GetToken",
            success: function (data) {
                var token = jQuery.parseJSON(data);
                $("#upload").attr("action", "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=" + token.access_token + "&type=image").submit();
                $("#result-iframe").show();
                $("#Msg").hide();
                

            }
        });
        
        //$.ajax({
        //    url: "/MsgMgr/getId",
        //    data: { file: m },
        //    success: function (data) {
        //        $("#Msg").val(data.media_id);
        //    },
        //    error: function (data) {
        //        $("#Msg").val(data);
        //    }
        //});
    });


    $("#sendAllMsg").click(function () {
        var m = $("#Text").val();
        if (m == null || m == "") {
            alert("请输入发送的内容");
            return;
        }
        $.ajax({
            url: "/MsgMgr/sendAllMsg",
            data: { text: m },
            success: function (data) {
                showHide();
                $("#Msg").val(data);
            },
            error: function (data) {
                showHide();
                $("#Msg").val(data);
            }
        });
    });
    function showHide() {
        $("#result-iframe").hide();
        $("#Msg").show();

    }


</script>